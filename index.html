<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visor de Plan Semanal - NutriGema</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Pacifico&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #f8f9fa;
            --card-bg: #ffffff;
            --primary-color: #2ecc71;
            --secondary-color: #3498db;
            --text-color: #34495e;
            --header-color: #2c3e50;
            --border-color: #e9ecef;
            --shadow: 0 10px 20px rgba(0,0,0,0.05);
            --border-radius: 16px;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 24px;
        }
        
        body.modal-open {
            overflow: hidden;
        }

        .container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
        }

        header h1 {
            font-family: 'Pacifico', cursive;
            color: var(--primary-color);
            font-size: 3rem;
            margin: 0;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }

        header p {
            font-size: 1.1rem;
            color: #7f8c8d;
        }
        
        /* View Switcher */
        .view-switcher {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
            background-color: var(--card-bg);
            border-radius: 50px;
            padding: 5px;
            box-shadow: var(--shadow);
            width: fit-content;
            margin-left: auto;
            margin-right: auto;
        }
        .view-switcher button {
            padding: 10px 25px;
            border: none;
            background-color: transparent;
            color: var(--text-color);
            border-radius: 50px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1rem;
            transition: all 0.3s ease;
        }
        .view-switcher button.active {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            box-shadow: 0 4px 10px rgba(46, 204, 113, 0.3);
        }

        .view { display: none; }
        .view.active { display: block; }
        
        /* Planner View */
        #plannerView {
            display: none;
            grid-template-columns: 300px 1fr;
            gap: 30px;
            align-items: flex-start;
        }
        #plannerView.active {
            display: grid;
        }
        
        #recipeLibrary {
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: var(--shadow);
            height: 80vh;
            overflow-y: auto;
            position: sticky;
            top: 20px;
        }
        #recipeLibrary h2, #priceCatalogView h2, #recipeLibraryView h2 {
            margin-top: 0; text-align: center; color: var(--header-color);
        }
        #recipeSearch, #fullLibrarySearch {
            width: 100%;
            padding: 10px;
            border-radius: 8px;
            border: 2px solid var(--border-color);
            margin-bottom: 20px;
            box-sizing: border-box;
        }

        .recipe-card-lib {
            padding: 15px;
            background-color: var(--bg-color);
            border-radius: 12px;
            margin-bottom: 10px;
            cursor: grab;
            border-left: 5px solid var(--primary-color);
        }
        .recipe-card-lib h4 { margin: 0 0 5px 0; }
        .recipe-card-lib p { margin: 0; font-size: 0.8rem; color: #7f8c8d; }

        #plannerCalendar {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }
        .calendar-day {
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
        }
        .calendar-day-header {
            padding: 10px;
            font-weight: 700;
            text-align: center;
            background-color: var(--header-color);
            color: white;
            border-radius: var(--border-radius) var(--border-radius) 0 0;
        }
        .meal-slot {
            padding: 10px;
            min-height: 100px;
            border-top: 1px solid var(--border-color);
        }
        .meal-slot.drag-over {
            background-color: #e8f8f5;
        }
        .meal-slot .recipe-card-lib {
            cursor: default;
        }
        .meal-slot h5 {
            margin: 0 0 10px 0;
            color: var(--secondary-color);
        }
        
        .planner-actions {
            margin-top: 20px;
            text-align: center;
        }
        
        @media (max-width: 900px) {
            #plannerView {
                grid-template-columns: 1fr;
            }
            #recipeLibrary {
                height: auto;
                max-height: 40vh;
                position: static;
            }
        }
        
        /* Price Catalog View */
        #priceCatalogView {
            background-color: var(--card-bg);
            padding: 30px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
        }
        .price-catalog-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }
        .price-item {
            display: flex;
            flex-direction: column;
            gap: 8px;
            background-color: var(--bg-color);
            padding: 15px;
            border-radius: 12px;
        }
        .price-item label {
            font-weight: 600;
        }
        .price-inputs {
            display: flex;
            gap: 8px;
        }
        .price-inputs input, .price-inputs select {
            width: 100%;
            padding: 8px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
        }
        .price-actions {
            text-align: center;
            margin-top: 30px;
        }
        
        /* Full Recipe Library View */
        #fullLibraryContent {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 30px;
        }
        .recipe-card-full {
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            overflow: hidden;
        }
        .recipe-card-full-header {
            padding: 20px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
        }
        .recipe-card-full-header h3 {
            margin: 0;
            font-size: 1.5rem;
        }
         .recipe-card-full-content {
            padding: 20px;
        }


        /* --- STYLES FOR THE "VIEW PLANS" MODE --- */
        .selectors-container { display: flex; flex-direction: column; gap: 20px; margin-bottom: 30px; align-items: center; }
        .top-controls { display: flex; flex-wrap: wrap; gap: 20px; justify-content: center; align-items: center; }
        .portion-selector { display: flex; align-items: center; gap: 10px; font-weight: 600; }
        #portionSelectorInput { width: 60px; padding: 8px; border-radius: 8px; border: 2px solid var(--border-color); text-align: center; font-weight: 600; }
        .action-buttons { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; }
        .action-btn { padding: 10px 20px; background: var(--secondary-color); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; }
        .action-btn:hover { background: #2980b9; box-shadow: 0 4px 10px rgba(52, 152, 219, 0.3); }
        #planSelector { padding: 10px 15px; border-radius: 8px; border: 2px solid var(--border-color); font-weight: 600; background-color: white; min-width: 250px; cursor: pointer; }
        .day-selector { display: flex; justify-content: center; flex-wrap: wrap; gap: 10px; }
        .day-selector button { padding: 10px 20px; border: 2px solid var(--border-color); background-color: var(--card-bg); color: var(--text-color); border-radius: 50px; cursor: pointer; font-weight: 600; font-size: 0.9rem; transition: all 0.3s ease; }
        .day-selector button:hover { background-color: var(--primary-color); color: white; border-color: var(--primary-color); }
        .day-selector button.active { background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); color: white; border-color: var(--primary-color); box-shadow: 0 4px 10px rgba(46, 204, 113, 0.3); }
        .week-grid { display: grid; justify-items: center; position: relative; min-height: 100px; }
        .loader { border: 4px solid var(--border-color); border-top: 4px solid var(--primary-color); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .day-card { background: var(--card-bg); border-radius: var(--border-radius); box-shadow: var(--shadow); overflow: hidden; width: 100%; max-width: 500px; }
        .day-header { padding: 16px 20px; background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); color: white; font-weight: 700; font-size: 1.25rem; text-align: center; }
        .meal { padding: 20px; border-bottom: 1px solid var(--border-color); cursor: pointer; }
        .meal:last-child { border-bottom: none; }
        .meal-header { display: flex; justify-content: space-between; align-items: center; }
        .meal-header h3 { margin: 0; font-size: 1.1rem; color: var(--header-color); font-weight: 600; }
        .meal-header span { font-size: 0.9rem; color: #95a5a6; text-align: right; }
        .meal-header .toggle-icon { transition: transform 0.3s ease; font-weight: bold; margin-left: 10px; }
        .meal.active .toggle-icon { transform: rotate(180deg); }
        .recipe-details { max-height: 0; overflow: hidden; transition: max-height 0.4s ease-out; }
        .recipe-details.show { max-height: 2500px; transition: max-height 0.8s ease-in; }
        .recipe-content { padding-top: 20px; display: grid; grid-template-columns: 1fr; gap: 20px; }
        @media (min-width: 600px) { .recipe-content { grid-template-columns: 1fr 1fr; } }
        .info-card, .chart-card, .details-section { background-color: var(--bg-color); padding: 16px; border-radius: 12px; border: 1px solid var(--border-color); }
        .details-section { grid-column: 1 / -1; }
        .chart-container { position: relative; height: 200px; width: 100%; }
        .details-section h4, .info-card h4, .chart-card h4 { margin-top: 0; color: var(--secondary-color); border-bottom: 2px solid var(--primary-color); padding-bottom: 8px; margin-bottom: 12px; }
        .info-card p { margin: 0; line-height: 1.6; }
        .info-card strong { color: var(--header-color); }
        .details-section ul, .details-section ol { padding-left: 20px; margin: 0; }
        .details-section li { margin-bottom: 8px; line-height: 1.6; }
        .shopping-list-btn { display: block; width: calc(100% - 40px); margin: 20px; padding: 12px; background: linear-gradient(135deg, #1abc9c, #16a085); color: white; border: none; border-radius: 10px; font-weight: 600; font-size: 1rem; cursor: pointer; transition: all 0.3s ease; }
        .shopping-list-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 12px rgba(22, 160, 133, 0.3); }

        /* --- MODAL STYLES --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); display: flex; justify-content: center; align-items: center; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease; z-index: 1000; }
        .modal-overlay.show { opacity: 1; visibility: visible; }
        .modal-content { background-color: white; padding: 30px; border-radius: var(--border-radius); width: 90%; max-width: 600px; max-height: 80vh; overflow-y: auto; transform: translateY(-50px); transition: transform 0.3s ease; }
        .modal-overlay.show .modal-content { transform: translateY(0); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); padding-bottom: 15px; margin-bottom: 20px; }
        .modal-header h2 { margin: 0; color: var(--header-color); }
        .close-modal { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #95a5a6; }
        .modal-options { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-options .include-check { display: flex; gap: 10px; align-items: center; font-size: 0.9rem; }
        .modal-options input { cursor: pointer; }
        .modal-actions { display: flex; gap: 10px; }
        .modal-actions button { padding: 8px 12px; font-size: 0.8rem; border-radius: 6px; }
        .shopping-list-category h3, .prep-step h3 { color: var(--primary-color); margin-top: 20px; margin-bottom: 10px; }
        .shopping-list-category ul { list-style: none; padding: 0; }
        .shopping-list-category li { display: flex; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--border-color); }
        .shopping-list-category input[type="checkbox"] { margin-right: 12px; width: 18px; height: 18px; cursor: pointer; }
        .shopping-list-category label { flex-grow: 1; }
        .shopping-list-category label.checked { text-decoration: line-through; color: #bdc3c7; }
        .list-item-cost { font-size: 0.9rem; color: #7f8c8d; margin-left: auto; padding-left: 10px; }
        .shopping-list-total { text-align: right; font-size: 1.2rem; font-weight: bold; margin-top: 20px; color: var(--header-color); }
        .prep-step { padding-bottom: 15px; margin-bottom: 15px; border-bottom: 1px solid var(--border-color); }
        .prep-step:last-child { border-bottom: none; }
        .prep-step p { margin: 5px 0; }
        .prep-step strong { color: var(--header-color); }
        @media print { body * { visibility: hidden; } .modal-overlay, .modal-overlay * { visibility: visible; } .modal-overlay { position: absolute; left: 0; top: 0; background-color: white; height: auto; overflow: visible; } .modal-content { box-shadow: none; border: none; width: 100%; max-width: 100%; max-height: none; padding: 0; } .modal-header, .modal-options, .modal-actions, .shopping-list-category input, .list-item-cost { display: none; } .shopping-list-category label.checked { text-decoration: none; color: var(--text-color); } }

    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>Mi Plan Semanal</h1>
        <p>Un plan divertido y creativo por NutriGema ✨</p>
    </header>

    <div class="view-switcher">
        <button id="viewPlansBtn" class="active">Ver Planes</button>
        <button id="createPlanBtn">Crear Mi Plan</button>
        <button id="myPricesBtn">Mis Precios</button>
        <button id="libraryBtn">Biblioteca</button>
    </div>

    <!-- VIEW 1: PREDEFINED PLANS -->
    <div id="viewPlansView" class="view active">
        <!-- Content for this view is generated by JS -->
    </div>

    <!-- VIEW 2: DRAG & DROP PLANNER -->
    <div id="plannerView" class="view">
        <div id="recipeLibrary">
            <h2>Biblioteca de Recetas</h2>
            <input type="text" id="recipeSearch" placeholder="Buscar recetas...">
            <div id="recipeLibraryContent"></div>
        </div>
        <div>
            <div class="top-controls" style="margin-bottom: 20px;">
                 <div class="action-buttons">
                    <button id="plannerWeeklyShopBtn" class="action-btn">🛒 Lista Semanal</button>
                    <!-- Meal prep for custom plans is a future feature -->
                 </div>
            </div>
            <div id="plannerCalendar"></div>
            <div class="planner-actions">
                 <button id="savePlanBtn" class="action-btn">💾 Guardar Plan</button>
                 <button id="clearPlanBtn" class="action-btn" style="background-color: #e74c3c;">Limpiar Plan</button>
            </div>
        </div>
    </div>
    
    <!-- VIEW 3: PRICE CATALOG -->
    <div id="priceCatalogView" class="view">
        <h2>Mi Catálogo de Precios</h2>
        <p style="text-align: center;">Introduce los precios de tu supermercado local para obtener estimaciones de costos precisas.</p>
        <div class="price-catalog-list" id="priceCatalogList"></div>
        <div class="price-actions">
            <button id="savePricesBtn" class="action-btn" style="background-color: var(--primary-color);">Guardar Mis Precios</button>
        </div>
    </div>

    <!-- VIEW 4: FULL RECIPE LIBRARY -->
    <div id="recipeLibraryView" class="view">
        <h2>Biblioteca de Recetas</h2>
        <input type="text" id="fullLibrarySearch" placeholder="Buscar recetas por nombre...">
        <div id="fullLibraryContent">
            <!-- Full recipe cards will be injected here -->
        </div>
    </div>


</div>

<!-- Modals -->
<div class="modal-overlay" id="shoppingListModal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="modalTitle">Lista de Compras</h2>
            <button class="close-modal" data-modal-id="shoppingListModal">&times;</button>
        </div>
        <div class="modal-options">
            <div class="include-check">
                <input type="checkbox" id="includeOptionals" checked>
                <label for="includeOptionals">Incluir opcionales</label>
            </div>
            <div class="modal-actions">
                <button id="printBtn" class="action-btn">🖨️ Imprimir</button>
                <button id="copyBtn" class="action-btn">📋 Copiar</button>
            </div>
        </div>
        <div id="shoppingListContent"></div>
    </div>
</div>
<div class="modal-overlay" id="mealPrepModal">
     <div class="modal-content">
        <div class="modal-header">
            <h2>Plan de Preparación Semanal</h2>
            <button class="close-modal" data-modal-id="mealPrepModal">&times;</button>
        </div>
        <div id="mealPrepContent"></div>
    </div>
</div>


<script>
	// --- STATE MANAGEMENT ---
	let BD_RECETAS = {};
	let PLANES_SEMANALES = {};
	let userPrices = {};
	let customPlans = [];
	let portionMultiplier = 1;
	let customPlan = {}; 

	// --- INITIALIZATION ---
	async function initializeApp() {
		try {
			const [recipesRes, plansRes] = await Promise.all([
				fetch('./data/BD_RECETAS.json'),
				fetch('./data/PLANES_SEMANALES.json')
			]);
			BD_RECETAS = await recipesRes.json();
			PLANES_SEMANALES = await plansRes.json();
			
			const mainContentArea = document.getElementById('viewPlansView');
			if (mainContentArea) mainContentArea.innerHTML = `<div class="selectors-container"><div class="top-controls"><select id="planSelector" aria-label="Seleccionar Plan Semanal"></select><div class="portion-selector"><label for="portionSelectorInput">Personas:</label><input type="number" id="portionSelectorInput" value="1" min="1"></div></div><div class="action-buttons"><button id="weeklyShopBtn" class="action-btn">🛒 Lista Semanal</button><button id="mealPrepBtn" class="action-btn">🍳 Plan de Preparación</button></div><div class="day-selector" id="daySelector"></div></div><div class="week-grid" id="weekGrid"><div class="loader" id="loader"></div></div>`;
			
			loadUserData();

			setupViewSwitcher();
			
			const daysOfWeek = ['lunes', 'martes', 'miercoles', 'jueves', 'viernes', 'sabado', 'domingo'];
			const today = new Date().getDay();
			const currentDayIndex = (today === 0) ? 6 : today - 1; 
			const currentDayKey = daysOfWeek[currentDayIndex];
			
			// Setup for all views
			createPlanSelector(); // Must run after loadUserData
			createDaySelector(daysOfWeek, currentDayKey);
			displayDay(currentDayKey);
			populateRecipeLibrary();
			createPlannerCalendar(daysOfWeek);
			renderCustomPlan();
			populatePriceCatalog();
			populateFullRecipeLibrary();
			
			// General setup
			setupModalListeners();
			setupActionButtons();
			setupPortionSelector();

		} catch (error) {
			console.error("Error loading data:", error);
			const mainContentArea = document.getElementById('viewPlansView');
			if (mainContentArea) mainContentArea.innerHTML = `<p style="text-align:center; color: #c0392b;">Error al cargar los datos.</p>`;
		}
	}

	document.addEventListener('DOMContentLoaded', initializeApp);

	function loadUserData() {
		userPrices = JSON.parse(localStorage.getItem('userPrices')) || {};
		customPlans = JSON.parse(localStorage.getItem('savedCustomPlans')) || [];
		const savedPlan = localStorage.getItem('customMealPlan');
		if (savedPlan) {
			customPlan = JSON.parse(savedPlan);
		} else {
			const daysOfWeek = ['lunes', 'martes', 'miercoles', 'jueves', 'viernes', 'sabado', 'domingo'];
			daysOfWeek.forEach(day => customPlan[day] = { almuerzo: null, cena: null });
		}
	}

	function setupViewSwitcher() {
		const buttons = document.querySelectorAll('.view-switcher button');
		const views = document.querySelectorAll('.view');

		buttons.forEach(button => {
			button.addEventListener('click', () => {
				buttons.forEach(btn => btn.classList.remove('active'));
				button.classList.add('active');

				const viewId = button.id.replace('Btn', 'View');
				views.forEach(view => {
					view.classList.remove('active');
					if(view.id === viewId) {
						view.classList.add('active');
					}
				});
			});
		});
	}

	// --- Price Catalog (View 3) ---
	function populatePriceCatalog() {
		const catalogList = document.getElementById('priceCatalogList');
		const uniqueIngredients = {};
		BD_RECETAS.recetas.forEach(recipe => {
			[...recipe.ingredientes, ...(recipe.ingredientesOpcionales || [])].forEach(ing => {
				if (!uniqueIngredients[ing.nombre]) {
					uniqueIngredients[ing.nombre] = ing;
				}
			});
		});
		
		catalogList.innerHTML = Object.values(uniqueIngredients).sort((a,b) => a.nombre.localeCompare(b.nombre)).map(ing => {
			const savedPrice = userPrices[ing.nombre] || {};
			return `
				<div class="price-item">
					<label for="price-${ing.nombre.replace(/\s+/g, '')}">${ing.nombre}</label>
					<div class="price-inputs">
						<input type="number" step="0.01" id="price-${ing.nombre.replace(/\s+/g, '')}" placeholder="Precio" data-name="${ing.nombre}" value="${savedPrice.precio || ''}">
						<span>por</span>
						<input type="number" step="0.01" id="qty-${ing.nombre.replace(/\s+/g, '')}" placeholder="Cant." data-name="${ing.nombre}" value="${savedPrice.cantidadBase || ''}">
						<select id="unit-${ing.nombre.replace(/\s+/g, '')}" data-name="${ing.nombre}">
							<option value="g" ${savedPrice.unidadBase === 'g' ? 'selected' : ''}>g</option>
							<option value="kg" ${savedPrice.unidadBase === 'kg' ? 'selected' : ''}>kg</option>
							<option value="ml" ${savedPrice.unidadBase === 'ml' ? 'selected' : ''}>ml</option>
							<option value="l" ${savedPrice.unidadBase === 'l' ? 'selected' : ''}>l</option>
							<option value="unidades" ${savedPrice.unidadBase === 'unidades' ? 'selected' : ''}>unidades</option>
						</select>
					</div>
				</div>
			`;
		}).join('');

		document.getElementById('savePricesBtn').addEventListener('click', () => {
			const inputs = catalogList.querySelectorAll('input, select');
			inputs.forEach(input => {
				const name = input.dataset.name;
				if(!userPrices[name]) userPrices[name] = {};
				if(input.id.startsWith('price-')) userPrices[name].precio = parseFloat(input.value) || 0;
				if(input.id.startsWith('qty-')) userPrices[name].cantidadBase = parseFloat(input.value) || 0;
				if(input.id.startsWith('unit-')) userPrices[name].unidadBase = input.value;
			});
			localStorage.setItem('userPrices', JSON.stringify(userPrices));
			alert('¡Precios guardados!');
		});
	}

	// --- Full Recipe Library (View 4) ---
	function populateFullRecipeLibrary() {
		const libraryContainer = document.getElementById('fullLibraryContent');
		libraryContainer.innerHTML = '';
		BD_RECETAS.recetas.forEach(recipe => {
			const card = document.createElement('div');
			card.className = 'recipe-card-full';
			card.innerHTML = createFullRecipeCardHTML(recipe);
			libraryContainer.appendChild(card);
		});
		
		BD_RECETAS.recetas.forEach(recipe => {
			createMacroChart(`full-chart-${recipe.id}`, recipe.resumenNutricional, 1); // Multiplier is 1 for library view
		});

		document.getElementById('fullLibrarySearch').addEventListener('input', (e) => {
			const searchTerm = e.target.value.toLowerCase();
			libraryContainer.querySelectorAll('.recipe-card-full').forEach(card => {
				const name = card.querySelector('h3').textContent.toLowerCase();
				card.style.display = name.includes(searchTerm) ? 'block' : 'none';
			});
		});
	}

	function createFullRecipeCardHTML(recipe) {
		const optionalIngredientsHTML = recipe.ingredientesOpcionales && recipe.ingredientesOpcionales.length > 0
			? `<h6>Ingredientes Opcionales</h6><ul>${recipe.ingredientesOpcionales.map(ing => `<li><strong>${ing.nombre}:</strong> ${ing.cantidad}</li>`).join('')}</ul>`
			: '';

		return `
			<div class="recipe-card-full-header"><h3>${recipe.nombre}</h3></div>
			<div class="recipe-card-full-content">
				<div class="recipe-content">
					<div class="info-card"><h4>Información General</h4><p><strong>Tiempo:</strong> ${recipe.tiempoPreparacionAproximado}</p><p><strong>Dificultad:</strong> ${recipe.dificultad}</p><p><strong>Calorías:</strong> ${recipe.resumenNutricional.caloriasTotales.toFixed(0)} kcal</p></div>
					<div class="chart-card"><h4>Macros (P/G/C)</h4><div class="chart-container"><canvas id="full-chart-${recipe.id}"></canvas></div></div>
					<div class="details-section"><h4>Ingredientes</h4><ul>${recipe.ingredientes.map(ing => `<li><strong>${ing.nombre}:</strong> ${ing.cantidad}</li>`).join('')}</ul>${optionalIngredientsHTML}</div>
					<div class="details-section"><h4>Instrucciones</h4><ol>${recipe.instrucciones.map(step => `<li>${step}</li>`).join('')}</ol></div>
					<div class="details-section"><h4>Consejos del Chef ✨</h4><ul>${recipe.consejosDelChef.map(tip => `<li>${tip}</li>`).join('')}</ul></div>
				</div>
			</div>
		`;
	}

	// --- Planner (View 2) ---
	function populateRecipeLibrary() {
		const libraryContent = document.getElementById('recipeLibraryContent');
		libraryContent.innerHTML = '';
		BD_RECETAS.recetas.forEach(recipe => {
			const card = document.createElement('div');
			card.className = 'recipe-card-lib';
			card.draggable = true;
			card.dataset.recipeId = recipe.id;
			card.innerHTML = `<h4>${recipe.nombre}</h4><p>${recipe.tipoDeComida} - ${recipe.dificultad}</p>`;
			libraryContent.appendChild(card);
			card.addEventListener('dragstart', handleDragStart);
		});

		document.getElementById('recipeSearch').addEventListener('input', (e) => {
			const searchTerm = e.target.value.toLowerCase();
			libraryContent.querySelectorAll('.recipe-card-lib').forEach(card => {
				const name = card.querySelector('h4').textContent.toLowerCase();
				card.style.display = name.includes(searchTerm) ? 'block' : 'none';
			});
		});
	}

	function createPlannerCalendar(days) {
		const calendar = document.getElementById('plannerCalendar');
		calendar.innerHTML = '';
		days.forEach(day => {
			const dayEl = document.createElement('div');
			dayEl.className = 'calendar-day';
			dayEl.innerHTML = `<div class="calendar-day-header">${day.charAt(0).toUpperCase() + day.slice(1)}</div>`;
			['almuerzo', 'cena'].forEach(meal => {
				const slot = document.createElement('div');
				slot.className = 'meal-slot';
				slot.dataset.day = day;
				slot.dataset.meal = meal;
				slot.innerHTML = `<h5>${meal.charAt(0).toUpperCase() + meal.slice(1)}</h5>`;
				slot.addEventListener('dragover', handleDragOver);
				slot.addEventListener('dragleave', handleDragLeave);
				slot.addEventListener('drop', handleDrop);
				dayEl.appendChild(slot);
			});
			calendar.appendChild(dayEl);
		});
	}

	function renderCustomPlan() {
		const slots = document.querySelectorAll('.meal-slot');
		slots.forEach(slot => {
			const oldCard = slot.querySelector('.recipe-card-lib');
			if(oldCard) oldCard.remove();
			
			const day = slot.dataset.day;
			const meal = slot.dataset.meal;
			if(customPlan[day] && customPlan[day][meal]) {
				const recipeId = customPlan[day][meal];
				const recipe = BD_RECETAS.recetas.find(r => r.id === recipeId);
				if(recipe) {
					const card = document.createElement('div');
					card.className = 'recipe-card-lib';
					card.innerHTML = `<h4>${recipe.nombre}</h4><p>${recipe.tipoDeComida} - ${recipe.dificultad}</p>`;
					slot.appendChild(card);
				}
			}
		});
	}

	function handleDragStart(e) { e.dataTransfer.setData('text/plain', e.target.dataset.recipeId); }
	function handleDragOver(e) { e.preventDefault(); e.currentTarget.classList.add('drag-over'); }
	function handleDragLeave(e) { e.currentTarget.classList.remove('drag-over'); }
	function handleDrop(e) {
		e.preventDefault();
		e.currentTarget.classList.remove('drag-over');
		const recipeId = e.dataTransfer.getData('text/plain');
		const day = e.currentTarget.dataset.day;
		const meal = e.currentTarget.dataset.meal;

		if (!customPlan[day]) customPlan[day] = {};
		customPlan[day][meal] = recipeId;
		
		saveCustomPlan();
		renderCustomPlan();
	}

	function saveCustomPlan() {
		localStorage.setItem('customMealPlan', JSON.stringify(customPlan));
	}

	// --- View Plans (View 1) ---
	function createPlanSelector() {
		const planSelector = document.getElementById('planSelector');
		planSelector.innerHTML = ''; // Clear options
		
		// Add predefined plans
		PLANES_SEMANALES.planesSemanales.forEach((plan, index) => {
			const option = document.createElement('option');
			option.value = `predefined-${index}`;
			option.textContent = plan.nombrePlan;
			planSelector.appendChild(option);
		});

		// Add custom plans
		customPlans.forEach((plan, index) => {
			const option = document.createElement('option');
			option.value = `custom-${index}`;
			option.textContent = plan.nombrePlan;
			planSelector.appendChild(option);
		});

		planSelector.addEventListener('change', () => {
			const activeDay = document.querySelector('.day-selector button.active').dataset.day;
			displayDay(activeDay);
		});
	}

	function displayDay(day) {
		const weekGrid = document.getElementById('weekGrid');
		weekGrid.innerHTML = '';
		
		const planSelector = document.getElementById('planSelector');
		if (!planSelector.value) return; // Exit if no plan is selected
		const [type, index] = planSelector.value.split('-');
		
		let plan;
		if (type === 'predefined') {
			plan = PLANES_SEMANALES.planesSemanales[index].planSemanal;
		} else {
			plan = customPlans[index].planSemanal;
		}

		const dayKey = day.charAt(0).toUpperCase() + day.slice(1);
		const dayCard = document.createElement('div');
		dayCard.className = 'day-card';
		dayCard.innerHTML = `<div class="day-header">${dayKey}</div>`;
		['almuerzo', 'cena'].forEach(mealType => {
			const recipeId = plan[day]?.[mealType];
			const recipe = BD_RECETAS.recetas.find(r => r.id === recipeId);
			if (recipe) {
				dayCard.appendChild(createMealElement(recipe, mealType));
			} else {
				 const emptyMeal = document.createElement('div');
				 emptyMeal.className = 'meal';
				 emptyMeal.innerHTML = `<div class="meal-header"><h3>${mealType.charAt(0).toUpperCase() + mealType.slice(1)}</h3><span>No hay receta seleccionada.</span></div>`;
				 dayCard.appendChild(emptyMeal);
			}
		});
		const shoppingListBtn = document.createElement('button');
		shoppingListBtn.className = 'shopping-list-btn';
		shoppingListBtn.textContent = '🛒 Generar Lista de Compras del Día';
		shoppingListBtn.onclick = () => showShoppingList({day: day});
		dayCard.appendChild(shoppingListBtn);
		weekGrid.appendChild(dayCard);
		addEventListeners();
	}

	// --- All other functions (shared logic, modals, etc.) ---
	function gcd(a, b) { return b === 0 ? a : gcd(b, a % b); }

	function formatIngredientQuantity(ing, multiplier) {
		const quantityStr = ing.cantidad;
		const fractionMatch = quantityStr.match(/(\d+)\/(\d+)/);
		const numberMatch = quantityStr.match(/(\d*\.?\d+)/);
		if (fractionMatch) {
			let num = parseInt(fractionMatch[1], 10) * multiplier;
			let den = parseInt(fractionMatch[2], 10);
			if (num >= den) {
				const whole = Math.floor(num / den);
				num %= den;
				if (num === 0) return `${whole} ${quantityStr.split(' ').slice(1).join(' ')}`;
				const common_frac = gcd(num, den);
				return `${whole} ${num / common_frac}/${den / common_frac} ${quantityStr.split(' ').slice(1).join(' ')}`;
			}
			const common = gcd(num, den);
			if (den/common === 1) return `${num/common}  ${quantityStr.split(' ').slice(1).join(' ')}`;
			return `${num / common}/${den / common} ${quantityStr.split(' ').slice(1).join(' ')}`;
		} else if (numberMatch) {
			const newAmount = parseFloat(numberMatch[0]) * multiplier;
			return quantityStr.replace(numberMatch[0], newAmount % 1 === 0 ? newAmount : parseFloat(newAmount.toFixed(2)));
		}
		return quantityStr;
	}

	function createMealElement(recipe, mealType) {
		const mealElement = document.createElement('div');
		mealElement.className = 'meal';
		mealElement.dataset.recipeId = recipe.id;
		const optionalIngredientsHTML = recipe.ingredientesOpcionales && recipe.ingredientesOpcionales.length > 0
			? `<h6>Ingredientes Opcionales</h6><ul>${recipe.ingredientesOpcionales.map(ing => `<li><strong>${ing.nombre}:</strong> ${formatIngredientQuantity(ing, portionMultiplier)}</li>`).join('')}</ul>`
			: '';
		mealElement.innerHTML = `
			<div class="meal-header">
				<div><h3>${mealType.charAt(0).toUpperCase() + mealType.slice(1)}</h3><span>${recipe.nombre}</span></div>
				<span class="toggle-icon">▼</span>
			</div>
			<div class="recipe-details">
				<div class="recipe-content">
					<div class="info-card"><h4>Información General</h4><p><strong>Tiempo:</strong> ${recipe.tiempoPreparacionAproximado}</p><p><strong>Dificultad:</strong> ${recipe.dificultad}</p><p><strong>Calorías:</strong> ${(recipe.resumenNutricional.caloriasTotales * portionMultiplier).toFixed(0)} kcal</p></div>
					<div class="chart-card"><h4>Macros (P/G/C)</h4><div class="chart-container"><canvas id="chart-${recipe.id}-${mealType}"></canvas></div></div>
					<div class="details-section"><h4>Ingredientes</h4><ul>${recipe.ingredientes.map(ing => `<li><strong>${ing.nombre}:</strong> ${formatIngredientQuantity(ing, portionMultiplier)}</li>`).join('')}</ul>${optionalIngredientsHTML}</div>
					<div class="details-section"><h4>Instrucciones</h4><ol>${recipe.instrucciones.map(step => `<li>${step}</li>`).join('')}</ol></div>
					<div class="details-section"><h4>Consejos del Chef ✨</h4><ul>${recipe.consejosDelChef.map(tip => `<li>${tip}</li>`).join('')}</ul></div>
				</div>
			</div>`;
		return mealElement;
	}

	function createMacroChart(canvasId, macros, multiplier = portionMultiplier) {
		const ctx = document.getElementById(canvasId);
		if (!ctx) return;
		if (window.chartInstances && window.chartInstances[canvasId]) {
			window.chartInstances[canvasId].destroy();
		}
		if(!window.chartInstances) window.chartInstances = {};
		window.chartInstances[canvasId] = new Chart(ctx.getContext('2d'), { type: 'doughnut', data: { labels: ['Proteínas (g)', 'Grasas (g)', 'Carbohidratos (g)'], datasets: [{ label: 'Macronutrientes', data: [ (macros.proteinasTotales * multiplier), (macros.grasasTotales * multiplier), (macros.carbohidratosTotales * multiplier) ], backgroundColor: ['rgba(46, 204, 113, 0.8)','rgba(241, 196, 15, 0.8)','rgba(52, 152, 219, 0.8)'], borderColor: ['rgba(46, 204, 113, 1)','rgba(241, 196, 15, 1)','rgba(52, 152, 219, 1)'], borderWidth: 1 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { boxWidth: 12, font: { size: 10 } } } } } });
	}

	function addEventListeners() {
		document.querySelectorAll('.meal').forEach(mealEl => {
			mealEl.addEventListener('click', (e) => {
				mealEl.classList.toggle('active');
				const details = mealEl.querySelector('.recipe-details');
				details.classList.toggle('show');
				const recipeId = mealEl.dataset.recipeId;
				const mealType = mealEl.querySelector('h3').textContent.toLowerCase();
				const canvasId = `chart-${recipeId}-${mealType}`;
				if (details.classList.contains('show')) {
					const recipe = BD_RECETAS.recetas.find(r => r.id === recipeId);
					setTimeout(() => createMacroChart(canvasId, recipe.resumenNutricional), 50);
				} else {
					if (window.chartInstances && window.chartInstances[canvasId]) {
						window.chartInstances[canvasId].destroy();
						delete window.chartInstances[canvasId];
					}
				}
			});
		});
	}

	function setupActionButtons() {
		document.getElementById('weeklyShopBtn').addEventListener('click', () => {
			const [type, index] = document.getElementById('planSelector').value.split('-');
			const planSource = type === 'predefined'
				? PLANES_SEMANALES.planesSemanales[index].planSemanal
				: customPlans[index].planSemanal;
			showShoppingList({ isWeekly: true, planSource: planSource });
		});
		
		document.getElementById('plannerWeeklyShopBtn').addEventListener('click', () => {
			showShoppingList({ isWeekly: true, planSource: customPlan });
		});
		
		document.getElementById('mealPrepBtn').addEventListener('click', showMealPrepPlan);

		document.getElementById('savePlanBtn').addEventListener('click', () => {
			const planName = prompt("Dale un nombre a tu plan:", "Mi Plan Personalizado");
			if (planName) {
				const newPlan = {
					idPlan: `custom-${Date.now()}`,
					nombrePlan: planName,
					descripcion: "Un plan personalizado creado por mí.",
					planSemanal: JSON.parse(JSON.stringify(customPlan)) // Deep copy
				};
				customPlans.push(newPlan);
				localStorage.setItem('savedCustomPlans', JSON.stringify(customPlans));
				alert(`¡Plan "${planName}" guardado!`);
				createPlanSelector(); // Refresh the selector
			}
		});

		document.getElementById('clearPlanBtn').addEventListener('click', () => {
			if (confirm("¿Estás seguro de que quieres limpiar el planificador?")) {
				const daysOfWeek = ['lunes', 'martes', 'miercoles', 'jueves', 'viernes', 'sabado', 'domingo'];
				daysOfWeek.forEach(day => customPlan[day] = { almuerzo: null, cena: null });
				saveCustomPlan();
				renderCustomPlan();
			}
		});
	}

	function setupPortionSelector() {
		const portionInput = document.getElementById('portionSelectorInput');
		portionInput.addEventListener('change', () => {
			const value = parseInt(portionInput.value, 10);
			if (value >= 1) {
				portionMultiplier = value;
				const activeDay = document.querySelector('.day-selector button.active').dataset.day;
				displayDay(activeDay);
			} else {
				portionInput.value = 1;
			}
		});
	}

	function generateShoppingList(recipeIds, includeOptionals) {
		const ingredientsToProcess = [];
		recipeIds.forEach(id => {
			if (!id) return;
			const recipe = BD_RECETAS.recetas.find(r => r.id === id);
			if (recipe) {
				ingredientsToProcess.push(...recipe.ingredientes);
				if (includeOptionals && recipe.ingredientesOpcionales) {
					ingredientsToProcess.push(...recipe.ingredientesOpcionales);
				}
			}
		});
		const consolidated = {};
		ingredientsToProcess.forEach(ing => {
			const key = `${ing.nombre}_${ing.unidadMetrica}`;
			if (!consolidated[key]) {
				consolidated[key] = { nombre: ing.nombre, cantidad: 0, unidad: ing.unidadMetrica, categoria: ing.categoria || 'Otros' };
			}
			consolidated[key].cantidad += (ing.cantidadMetrica * portionMultiplier);
		});

		const categorized = {};
		let totalCost = 0;
		for (const key in consolidated) {
			const item = consolidated[key];
			// Cost calculation
			const priceInfo = userPrices[item.nombre];
			if (priceInfo && priceInfo.precio > 0 && priceInfo.cantidadBase > 0) {
				let itemAmountInBaseUnit = item.cantidad;
				// Convert kg to g and l to ml for calculation
				if (item.unidad === 'kg') itemAmountInBaseUnit *= 1000;
				if (item.unidad === 'l') itemAmountInBaseUnit *= 1000;

				let priceAmountInBaseUnit = priceInfo.cantidadBase;
				if (priceInfo.unidadBase === 'kg') priceAmountInBaseUnit *= 1000;
				if (priceInfo.unidadBase === 'l') priceAmountInBaseUnit *= 1000;

				if ((priceInfo.unidadBase.startsWith('k') || priceInfo.unidadBase.startsWith('g')) && (item.unidad.startsWith('k') || item.unidad.startsWith('g')) ||
					(priceInfo.unidadBase.startsWith('m') || priceInfo.unidadBase.startsWith('l')) && (item.unidad.startsWith('m') || item.unidad.startsWith('l')) ||
					(priceInfo.unidadBase === 'unidades' && item.unidad === 'unidades')) {
					item.costo = (itemAmountInBaseUnit / priceAmountInBaseUnit) * priceInfo.precio;
					totalCost += item.costo;
				}
			}

			if (!categorized[item.categoria]) categorized[item.categoria] = [];
			categorized[item.categoria].push(item);
		}
		return { categorized, totalCost };
	}

	function displayShoppingList(categorizedList, totalCost) {
		const contentDiv = document.getElementById('shoppingListContent');
		contentDiv.innerHTML = '';
		const sortedCategories = Object.keys(categorizedList).sort();

		if (sortedCategories.length === 0) {
			contentDiv.innerHTML = '<p>No hay ingredientes para mostrar. Arrastra recetas a tu plan para empezar.</p>';
			return;
		}

		sortedCategories.forEach(category => {
			const categoryDiv = document.createElement('div');
			categoryDiv.className = 'shopping-list-category';
			const title = document.createElement('h3');
			title.textContent = category;
			categoryDiv.appendChild(title);
			const ul = document.createElement('ul');
			categorizedList[category].forEach(item => {
				const li = document.createElement('li');
				const checkbox = document.createElement('input');
				checkbox.type = 'checkbox';
				const checkboxId = `item-${category}-${item.nombre.replace(/\s+/g, '-')}`;
				checkbox.id = checkboxId;
				const label = document.createElement('label');
				label.htmlFor = checkboxId;
				label.textContent = `${item.nombre} - ${item.cantidad % 1 === 0 ? item.cantidad : item.cantidad.toFixed(2)} ${item.unidad}`;
				const costSpan = document.createElement('span');
				costSpan.className = 'list-item-cost';
				costSpan.textContent = item.costo ? `$${item.costo.toFixed(2)}` : '';

				checkbox.onchange = () => label.classList.toggle('checked', checkbox.checked);
				li.appendChild(checkbox);
				li.appendChild(label);
				li.appendChild(costSpan);
				ul.appendChild(li);
			});
			categoryDiv.appendChild(ul);
			contentDiv.appendChild(categoryDiv);
		});

		if (totalCost > 0) {
			const totalDiv = document.createElement('div');
			totalDiv.className = 'shopping-list-total';
			totalDiv.textContent = `Costo Estimado Total: $${totalCost.toFixed(2)}`;
			contentDiv.appendChild(totalDiv);
		}
	}

	function showShoppingList(options) {
		const { day, isWeekly = false } = options;
		const isPredefinedView = document.getElementById('viewPlansBtn').classList.contains('active');
		
		let planSource;
		if (isPredefinedView) {
			const [type, index] = document.getElementById('planSelector').value.split('-');
			planSource = type === 'predefined'
				? PLANES_SEMANALES.planesSemanales[index].planSemanal
				: customPlans[index].planSemanal;
		} else {
			planSource = customPlan;
		}

		const recipeIds = isWeekly 
			? Object.values(planSource).flatMap(d => Object.values(d))
			: [planSource[day]?.almuerzo, planSource[day]?.cena];
		
		const modal = document.getElementById('shoppingListModal');
		const includeOptionalsCheckbox = document.getElementById('includeOptionals');
		
		function updateList() {
			const { categorized, totalCost } = generateShoppingList(recipeIds, includeOptionalsCheckbox.checked);
			displayShoppingList(categorized, totalCost);
		}

		updateList();
		includeOptionalsCheckbox.onchange = updateList;
		
		document.getElementById('modalTitle').textContent = isWeekly ? 'Lista de Compras Semanal' : `Lista de Compras - ${day.charAt(0).toUpperCase() + day.slice(1)}`;
		modal.classList.add('show');
		document.body.classList.add('modal-open');
	}

	function showMealPrepPlan() {
		const isPredefinedView = document.getElementById('viewPlansBtn').classList.contains('active');
		let planData;

		if (isPredefinedView) {
			const [type, index] = document.getElementById('planSelector').value.split('-');
			planData = type === 'predefined'
				? PLANES_SEMANALES.planesSemanales[index]
				: customPlans[index]; // Custom plans don't have meal prep info yet
		} else {
			// For custom plan view, show a generic message
			planData = { planDePreparacionSemanal: { pasosDePrepa: [ { descripcion: "El plan de preparación se basa en planes predefinidos.", componente: "N/A", recetasRelacionadas: [], instruccionesAlmacenamiento: "Selecciona un plan predefinido en la vista 'Ver Planes' para ver su guía de preparación."} ] } };
		}
			
		const mealPrepPlan = planData?.planDePreparacionSemanal;
		const modal = document.getElementById('mealPrepModal');
		const contentDiv = document.getElementById('mealPrepContent');
		contentDiv.innerHTML = '';

		if (mealPrepPlan && mealPrepPlan.pasosDePrepa) {
			mealPrepPlan.pasosDePrepa.forEach(step => {
				const stepDiv = document.createElement('div');
				stepDiv.className = 'prep-step';
				const recipeNames = step.recetasRelacionadas[0] === 'todas'
					? "Todas las recetas de la semana"
					: step.recetasRelacionadas.map(id => BD_RECETAS.recetas.find(r => r.id === id)?.nombre).filter(Boolean).join(', ');
				stepDiv.innerHTML = `<h3>${step.descripcion}</h3><p><strong>Componente:</strong> ${step.componente}</p><p><strong>Recetas:</strong> ${recipeNames || 'N/A'}</p><p><strong>Almacenamiento:</strong> ${step.instruccionesAlmacenamiento}</p>`;
				contentDiv.appendChild(stepDiv);
			});
		} else {
			contentDiv.innerHTML = '<p>No hay plan de preparación disponible para este plan.</p>';
		}
		modal.classList.add('show');
		document.body.classList.add('modal-open');
	}

	function setupModalListeners() {
		document.querySelectorAll('.modal-overlay').forEach(modal => {
			const closeModalBtn = modal.querySelector('.close-modal');
			const modalId = closeModalBtn.dataset.modalId;
			function closeModal() { document.getElementById(modalId).classList.remove('show'); document.body.classList.remove('modal-open'); }
			closeModalBtn.addEventListener('click', closeModal);
			modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });
		});
		document.getElementById('printBtn').addEventListener('click', () => window.print());
		document.getElementById('copyBtn').addEventListener('click', copyShoppingListToClipboard);
	}

	function copyShoppingListToClipboard() {
		const contentDiv = document.getElementById('shoppingListContent');
		let textToCopy = `${document.getElementById('modalTitle').textContent}\n\n`;
		contentDiv.querySelectorAll('.shopping-list-category').forEach(category => {
			const title = category.querySelector('h3').textContent;
			textToCopy += `--- ${title.toUpperCase()} ---\n`;
			category.querySelectorAll('li label').forEach(label => { textToCopy += `- ${label.textContent}\n`; });
			textToCopy += '\n';
		});
		const totalCostEl = contentDiv.querySelector('.shopping-list-total');
		if (totalCostEl) {
			textToCopy += `${totalCostEl.textContent}\n`;
		}
		navigator.clipboard.writeText(textToCopy).then(() => {
			const copyBtn = document.getElementById('copyBtn');
			const originalText = copyBtn.textContent;
			copyBtn.textContent = '¡Copiado!';
			setTimeout(() => { copyBtn.textContent = originalText; }, 2000);
		}).catch(err => {
			console.error('Error al copiar la lista: ', err);
			alert('No se pudo copiar la lista.');
		});
	}

</script>
</body>
</html>